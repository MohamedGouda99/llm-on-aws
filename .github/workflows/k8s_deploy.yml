name: Deploy to Kubernetes

on:
  push:
    branches:
      - main

jobs:
  deploy:
    if: github.event.head_commit.message == 'k8s deploy'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: k8s

    env:
      ECR_REPO: ${{ secrets.ECR_REPOSITORY }}
      AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: "v1.24.0"

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Update kubeconfig
      run: aws eks update-kubeconfig --name hr-stag-eksdemo1 --region ${{ env.AWS_REGION }}

    - name: Get latest image tag from ECR
      id: get-tag
      run: |
        TAG=$(aws ecr describe-images \
          --repository-name $ECR_REPO \
          --region $AWS_REGION \
          --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' \
          --output text)
        IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPO:$TAG"
        echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

    - name: Inject image URI into manifest
      run: |
        sed -i "s|image:.*|image: $IMAGE_URI|" deployment.yml

    - name: Deploy to Kubernetes
      run: |
        kubectl apply -f deployment.yml && kubectl apply -f svc.yml
